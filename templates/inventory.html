{% extends "base.html" %}
{% block title %}Inventory - POS{% endblock %}
{% block page_title %}Inventory{% endblock %}
{% block content %}
<div class="section-header">
    <div>
        <h2 class="section-title">Inventory</h2>
        <p class="section-subtitle">{{ products|length }} items currently registered.</p>
    </div>
    <button data-modal-open="addProductModal" class="btn btn-primary" type="button">Add Product</button>
</div>

<article class="card panel table-wrap">
    <table id="inventoryTable" class="fit-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Qty</th>
                <th class="col-action">Action</th>
            </tr>
        </thead>
        <tbody>
        {% for p in products %}
            <tr>
                <td>{{ p['id'] }}</td>
                <td>{{ p['name'] }}</td>
                <td>{{ p['category'] }}</td>
                <td>${{ '%.2f'|format(p['price']) }}</td>
                <td>
                    {{ p['quantity'] }}
                    {% if p['quantity'] <= p['low_stock_threshold'] %}
                    <span class="badge badge-warn">Low</span>
                    {% else %}
                    <span class="badge badge-ok">OK</span>
                    {% endif %}
                </td>
                <td class="col-action">
                    <button
                        class="btn btn-muted"
                        type="button"
                        data-open-update-modal
                        data-product-name="{{ p['name'] }}"
                        data-product-price="{{ '%.2f'|format(p['price']) }}"
                        data-update-action="{{ url_for('inventory_update_price', product_id=p['id']) }}"
                    >
                        Update
                    </button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</article>

<div id="addProductModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" data-modal-close></div>
    <div class="modal-dialog card panel" role="dialog" aria-modal="true" aria-labelledby="addProductTitle">
        <div class="section-header">
            <div>
                <h2 id="addProductTitle" class="section-title">New Inventory Item</h2>
                <p class="section-subtitle">Add a product without leaving this page.</p>
            </div>
            <button class="btn btn-muted" type="button" data-modal-close>Close</button>
        </div>

        <form method="POST" action="{{ url_for('inventory_add') }}" class="field-grid">
            <div class="field">
                <label for="modal_name">Name</label>
                <input id="modal_name" type="text" name="name" required>
            </div>
            <div class="field">
                <label for="modal_category">Category</label>
                <input id="modal_category" type="text" name="category" value="General" required>
            </div>
            <div class="field">
                <label for="modal_price">Price</label>
                <input id="modal_price" type="number" step="0.01" min="0" name="price" required>
            </div>
            <div class="field">
                <label for="modal_quantity">Quantity</label>
                <input id="modal_quantity" type="number" min="0" name="quantity" required>
            </div>
            <div class="inline-actions modal-actions">
                <button class="btn btn-primary" type="submit">Save Product</button>
            </div>
        </form>
    </div>
</div>

<div id="updatePriceModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" data-modal-close></div>
    <div class="modal-dialog card panel" role="dialog" aria-modal="true" aria-labelledby="updatePriceTitle">
        <div class="section-header">
            <div>
                <h2 id="updatePriceTitle" class="section-title">Update Price</h2>
                <p id="updatePriceProductName" class="section-subtitle"></p>
            </div>
            <button class="btn btn-muted" type="button" data-modal-close>Close</button>
        </div>

        <form id="updatePriceForm" method="POST" class="field-grid" style="grid-template-columns: 1fr;">
            <div class="field">
                <label for="update_price">New Price</label>
                <input id="update_price" type="number" step="0.01" min="0" name="price" required>
            </div>
            <div class="inline-actions modal-actions">
                <button class="btn btn-primary" type="submit">Update Price</button>
            </div>
        </form>
    </div>
</div>

<script>
const updatePriceModal = document.getElementById('updatePriceModal');
const updatePriceForm = document.getElementById('updatePriceForm');
const updatePriceInput = document.getElementById('update_price');
const updatePriceProductName = document.getElementById('updatePriceProductName');

document.querySelectorAll('[data-open-update-modal]').forEach((btn) => {
  btn.addEventListener('click', () => {
    const productName = btn.getAttribute('data-product-name') || '';
    const productPrice = btn.getAttribute('data-product-price') || '';
    const updateAction = btn.getAttribute('data-update-action') || '';

    if (updatePriceProductName) updatePriceProductName.textContent = productName;
    if (updatePriceInput) updatePriceInput.value = productPrice;
    if (updatePriceForm && updateAction) updatePriceForm.action = updateAction;

    updatePriceModal?.classList.add('is-open');
    updatePriceModal?.setAttribute('aria-hidden', 'false');
  });
});
</script>
{% endblock %}
