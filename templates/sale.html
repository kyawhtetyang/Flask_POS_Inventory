{% extends "base.html" %}
{% block title %}Sales - POS{% endblock %}
{% block page_title %}Sales{% endblock %}
{% block content %}
<div class="section-header">
    <div>
        <h2 class="section-title">New Sale</h2>
        <p class="section-subtitle">Select quantities and complete payment.</p>
    </div>
    <button class="btn btn-primary" type="submit" form="saleForm">Complete Sale</button>
</div>

<div class="grid-2" style="grid-template-columns: 2fr 1fr;">
    <article class="card panel table-wrap">
        <form method="POST" id="saleForm">
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Unit Price</th>
                        <th>Qty</th>
                    </tr>
                </thead>
                <tbody>
                {% for p in products %}
                    <tr>
                        <td>{{ p['name'] }}</td>
                        <td>${{ '%.2f'|format(p['price']) }}</td>
                        <td>
                            <input type="number" min="0" value="0" name="qty_{{ p['id'] }}" class="qty-input" data-price="{{ p['price'] }}" style="max-width: 90px;">
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

            <div class="field-grid" style="margin-top: 14px;">
                <div class="field">
                    <label for="discount">Discount</label>
                    <input id="discount" type="number" step="0.01" min="0" value="0" name="discount">
                </div>
                <div class="field">
                    <label for="tax">Tax</label>
                    <input id="tax" type="number" step="0.01" min="0" value="0" name="tax">
                </div>
                <div class="field">
                    <label for="payment_method">Payment Method</label>
                    <select id="payment_method" name="payment_method">
                        <option>Cash</option>
                        <option>Card</option>
                        <option>Wallet</option>
                    </select>
                </div>
                <div class="field">
                    <label for="customer_name">Customer Name (optional)</label>
                    <input id="customer_name" type="text" name="customer_name">
                </div>
            </div>
        </form>
    </article>

    <aside class="card panel">
        <h2 class="section-title">Summary</h2>
        <ul class="metric-list" style="margin-top: 14px;">
            <li class="metric-item"><span class="metric-key">Subtotal</span><span id="subtotalValue" class="metric-value">$0.00</span></li>
            <li class="metric-item"><span class="metric-key">Tax</span><span id="taxValue" class="metric-value">$0.00</span></li>
            <li class="metric-item"><span class="metric-key">Discount</span><span id="discountValue" class="metric-value">-$0.00</span></li>
            <li class="metric-item"><span class="metric-key">Total</span><span id="totalValue" class="metric-value">$0.00</span></li>
        </ul>
    </aside>
</div>

<script>
const qtyInputs = Array.from(document.querySelectorAll('.qty-input'));
const discountInput = document.getElementById('discount');
const taxInput = document.getElementById('tax');

function toNum(v) {
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : 0;
}

function calc() {
  let subtotal = 0;
  qtyInputs.forEach((input) => {
    const qty = Math.max(0, toNum(input.value));
    const price = toNum(input.dataset.price);
    subtotal += qty * price;
  });

  const tax = Math.max(0, toNum(taxInput?.value));
  const discount = Math.max(0, toNum(discountInput?.value));
  const total = Math.max(0, subtotal - discount + tax);

  document.getElementById('subtotalValue').textContent = `$${subtotal.toFixed(2)}`;
  document.getElementById('taxValue').textContent = `$${tax.toFixed(2)}`;
  document.getElementById('discountValue').textContent = `-$${discount.toFixed(2)}`;
  document.getElementById('totalValue').textContent = `$${total.toFixed(2)}`;
}

qtyInputs.forEach((i) => i.addEventListener('input', calc));
discountInput?.addEventListener('input', calc);
taxInput?.addEventListener('input', calc);
calc();
</script>
{% endblock %}
